#!/usr/bin/env zsh
set -euo pipefail

ROOT_DIR="$(cd "$(dirname "${(%):-%x}")/.." && pwd)"

echo "Bootstrapping repo in ${ROOT_DIR}"

# Check Homebrew
command -v brew >/dev/null 2>&1 || {
  echo "Homebrew required. Install from https://brew.sh/" >&2
  exit 1
}

# Install system dependencies
echo "Installing system dependencies..."
brew bundle --file="${ROOT_DIR}/Brewfile"

# Authenticate 1Password
export OP_ACCOUNT="my.1password.com"
echo "Authenticating with 1Password..."
op whoami >/dev/null 2>&1 || op signin --account "$OP_ACCOUNT"

# Set up Node
echo "Setting up Node..."
export PATH="${HOME}/.nodenv/bin:${PATH}"
eval "$(nodenv init -)"

NODE_VERSION="$(cat "${ROOT_DIR}/.node-version")"
echo "Using Node ${NODE_VERSION}"
nodenv install -s "$NODE_VERSION"
nodenv local "$NODE_VERSION"
nodenv rehash

# Set up pnpm
echo "Setting up pnpm..."
corepack enable
PNPM_VERSION="$(node -e "console.log(require('./package.json').packageManager.match(/pnpm@([^+]+)/)[1])")"
corepack prepare "pnpm@${PNPM_VERSION}" --activate

# Install Turbo
if ! command -v turbo >/dev/null 2>&1; then
  echo "Installing Turbo CLI..."
  npm -g install turbo
  nodenv rehash
fi

# Install dependencies and run setup
cd "$ROOT_DIR"
pnpm install
turbo setup

# Add direnv hook to .zshrc if missing (shell-specific, can't be in CLI)
if ! grep -q "direnv hook" ~/.zshrc 2>/dev/null; then
  echo "" >> ~/.zshrc
  echo '# direnv hook (added by dg bootstrap)' >> ~/.zshrc
  echo 'eval "$(direnv hook zsh)"' >> ~/.zshrc
  echo "Added direnv hook to ~/.zshrc"
fi

# Activate direnv for this session
eval "$(direnv hook zsh)"
direnv allow .

echo "Bootstrap complete."
