#!/usr/bin/env zsh
set -euo pipefail

ROOT="$(cd "$(dirname "${(%):-%x}")/.." && pwd)"
OUTPUT_FILE="${ROOT}/.env"
KEYS_FILE="${ROOT}/config/env.secrets.keys"

# Build list of keys to fetch from 1Password
declare -A keys_to_fetch  # Maps: 1Password key -> .env key

while read -r key; do
  [[ -z "$key" || "$key" == \#* ]] && continue
  keys_to_fetch[$key]=$key
done < "$KEYS_FILE"

# Get expected output keys (what will be written to .env)
expected_keys=$(printf '%s\n' "${keys_to_fetch[@]}" | sort -u)

# Check if .env exists with correct keys
if [[ -f "$OUTPUT_FILE" ]]; then
  existing_keys=$(grep -v '^#' "$OUTPUT_FILE" | grep -v '^$' | cut -d= -f1 | sort)
  
  if [[ "$expected_keys" == "$existing_keys" ]]; then
    echo ".env already exists with correct keys" >&2
    exit 0
  fi
  
  echo ".env keys mismatch, regenerating..." >&2
fi

# Remove old .env if regenerating
rm -f "$OUTPUT_FILE"

# Check 1Password auth
export OP_ACCOUNT="my.1password.com"
if ! op whoami >/dev/null 2>&1; then
  echo "Signing in to 1Password..." >&2
  op signin --account "$OP_ACCOUNT" || {
    echo "1Password sign-in failed. Enable: 1Password > Settings > Developer > Integrate with 1Password CLI" >&2
    exit 1
  }
fi

# Fetch secrets in parallel
echo "Fetching secrets from 1Password..." >&2
TMP_DIR="$(mktemp -d)"
trap "rm -rf '$TMP_DIR'" EXIT

for op_key in "${(@k)keys_to_fetch}"; do
  env_key="${keys_to_fetch[$op_key]}"
  # Store both the op_key and env_key in the filename for later
  (op read "op://dg/${op_key}/value" > "${TMP_DIR}/${op_key}::${env_key}" 2>&1) &
done
wait

# Write secrets to .env
for file in "$TMP_DIR"/*; do
  [[ -f "$file" ]] || continue
  filename="$(basename "$file")"
  op_key="${filename%%::*}"
  env_key="${filename##*::}"
  value="$(cat "$file")"
  
  if [[ -z "$value" || "$value" == *"ERROR"* ]]; then
    echo "Failed to read $op_key from 1Password" >&2
    exit 1
  fi
  
  # Escape for .env format
  value="${value//\\/\\\\}"
  value="${value//\"/\\\"}"
  value="${value//$'\n'/\\n}"
  
  echo "${env_key}=\"${value}\"" >> "$OUTPUT_FILE"
done

echo "Generated .env"
