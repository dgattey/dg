# Services

Server-side API integrations and data fetching for external services. This package is marked `server-only` to ensure these functions only run on the server.

## Structure

```
services/
├── clients/          # Reusable HTTP client utilities
├── images/           # Server-side image utilities
├── contentful/       # Contentful CMS integration
├── github/           # GitHub API integration
├── spotify/          # Spotify API integration
├── strava/           # Strava API integration
```

## Clients

Low-level HTTP client utilities used by service integrations:

| File | Description |
|------|-------------|
| `authenticatedGraphQLClient.ts` | GraphQL client with OAuth token refresh |
| `authenticatedRestClient.ts` | REST client with OAuth token refresh |
| `unauthenticatedRestClient.ts` | Simple REST client without auth |
| `refreshedAccessToken.ts` | Token refresh logic for OAuth flows |
| `RefreshTokenConfig.ts` | Configuration type for token refresh |
| `getStatus.ts` | HTTP status code helpers |
| `maskSecret.ts` | Utility to mask secrets in logs |

## Images

Server-side image utilities for creating UI-friendly derived data.

| Export | Description |
|--------|-------------|
| `getImageGradientFromUrl()` | Builds a CSS gradient + contrast hint from an image URL |

## Contentful

CMS integration for site content. Uses GraphQL with generated types.

| Export | Description |
|--------|-------------|
| `fetchIntroContent()` | Homepage intro text block and image |
| `fetchProjects()` | Project cards for homepage |
| `fetchFooterLinks()` | Footer navigation links |
| `fetchCurrentLocation()` | Current map location marker |
| `contentfulClient` | Configured GraphQL client |

**Generated files** (`*.generated.ts`): Auto-generated by `turbo codegen` from GraphQL queries. Do not edit manually.

**Type imports from `ui` package** (type-only, no runtime dependency):
- `ui/dependent/Image.tsx` → `Asset`
- `ui/dependent/ContentCard.tsx` → `Link`
- `ui/dependent/ContentWrappingLink.tsx` → `Link`

## Spotify

Spotify API integration for currently playing/recently played tracks.

| Export | Description |
|--------|-------------|
| `fetchRecentlyPlayed()` | Gets recently played or currently playing track |
| `spotifyClient` | Configured REST client with token refresh |
| `CurrentlyPlaying` | Type for currently playing response |
| `RecentlyPlayed` | Type for recently played response |
| `Track` | Shared track type |

## Strava

Strava API integration for activity data and webhooks.

| Export | Description |
|--------|-------------|
| `fetchLatestStravaActivityFromDb()` | Gets latest activity from database cache |
| `fetchStravaActivityFromApi()` | Fetches activity directly from Strava API |
| `syncStravaWebhookUpdateWithDb()` | Syncs webhook updates to database |
| `echoStravaChallengeIfValid()` | Handles Strava webhook verification |
| `runOauthFlow()` | Initiates OAuth token exchange |
| `paredStravaActivity()` | Transforms raw activity to display format |
| `stravaClient` | Configured REST client with token refresh |
| `stravaTokenExchangeClient` | Client for OAuth token exchange |
| `StravaWebhookEvent` | Type for incoming webhook payloads |

## Environment Variables

Required environment variables (see `config/env.secrets.keys`):

- `CONTENTFUL_ACCESS_TOKEN` - Contentful API access token
- `CONTENTFUL_SPACE_ID` - Contentful space identifier
- `SPOTIFY_CLIENT_ID` / `SPOTIFY_CLIENT_SECRET` - Spotify OAuth credentials
- `STRAVA_CLIENT_ID` / `STRAVA_CLIENT_SECRET` - Strava OAuth credentials
- `STRAVA_TOKEN_NAME` - Database token identifier
- `STRAVA_VERIFY_TOKEN` - Webhook verification token
- `DATABASE_URL` - PostgreSQL connection string (for Strava caching)

## Dependencies

- `db` - Database models for Strava activity caching
- `shared-core` - Shared utilities
- `graphql-request` - GraphQL client
- `wretch` - Fetch wrapper for REST APIs
