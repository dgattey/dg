# Auto-bump version on PRs and create releases on merge
name: Release

on:
  pull_request:
    types: [opened, edited, synchronize, closed]
    branches: [main]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  TURBO_TOKEN: ${{ secrets.TURBO_TOKEN }}
  TURBO_TEAM: ${{ vars.TURBO_TEAM }}

jobs:
  bump:
    name: "ðŸ“¦ Bump version"
    if: github.event.action != 'closed'
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: Checkout PR head with full history
        uses: actions/checkout@v4
        with:
          ref: ${{ github.head_ref }}
          fetch-depth: 0
          token: ${{ secrets.PAT_FOR_ACTIONS }}

      - uses: pnpm/action-setup@v4
      - uses: actions/setup-node@v4
        with:
          node-version-file: .node-version
          cache: "pnpm"

      - name: Install dependencies
        run: pnpm install

      - name: Configure git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Check if last commit is bot version bump
        id: check-bot-commit
        run: |
          set -euo pipefail
          LAST_AUTHOR=$(git log -1 --format='%an')
          if [ "$LAST_AUTHOR" = "github-actions[bot]" ]; then
            echo "Last commit was by bot. Skipping version bump."
            echo "SKIP=true" >> "$GITHUB_OUTPUT"
          else
            echo "Last commit by ${LAST_AUTHOR}. Proceeding with version bump check."
            echo "SKIP=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Parse PR info
        id: pr-info
        if: steps.check-bot-commit.outputs.SKIP == 'false'
        run: |
          set -euo pipefail
          OUTPUT=$(pnpm --filter=@dg/cli --silent version:pr-info "$GITHUB_EVENT_PATH")
          echo "$OUTPUT"
          echo "$OUTPUT" >> "$GITHUB_OUTPUT"

      - name: Read current version
        id: current-version
        if: steps.check-bot-commit.outputs.SKIP == 'false'
        run: |
          set -euo pipefail
          OUTPUT=$(pnpm --filter=@dg/cli --silent version:read)
          echo "$OUTPUT"
          echo "$OUTPUT" >> "$GITHUB_OUTPUT"

      - name: Compute target version
        id: target-version
        if: steps.check-bot-commit.outputs.SKIP == 'false'
        run: |
          set -euo pipefail
          git fetch --tags
          OUTPUT=$(pnpm --filter=@dg/cli --silent version:target-from-tags "${{ steps.current-version.outputs.VERSION }}" "${{ steps.pr-info.outputs.RELEASE_TYPE }}")
          echo "$OUTPUT"
          echo "$OUTPUT" >> "$GITHUB_OUTPUT"

      - name: Upsert PR version comment
        if: steps.check-bot-commit.outputs.SKIP == 'false'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          VERSION: ${{ steps.target-version.outputs.VERSION_TO }}
        run: |
          set -euo pipefail
          pnpm --filter=@dg/cli --silent version:pr-comment "$GITHUB_EVENT_PATH" "$VERSION" will-be

      - name: Check if bump needed
        id: check-bump
        if: steps.check-bot-commit.outputs.SKIP == 'false'
        run: |
          CURRENT="${{ steps.current-version.outputs.VERSION }}"
          TARGET="${{ steps.target-version.outputs.VERSION_TO }}"
          if [ "$CURRENT" = "$TARGET" ]; then
            echo "Version already at target ${TARGET}. Skipping."
            echo "SKIP=true" >> "$GITHUB_OUTPUT"
          else
            echo "Version needs bump to ${TARGET}"
            echo "SKIP=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Bump version
        id: bump
        if: steps.check-bot-commit.outputs.SKIP == 'false' && steps.check-bump.outputs.SKIP == 'false'
        run: |
          set -euo pipefail
          OUTPUT=$(pnpm --filter=@dg/cli --silent version:bump "${{ steps.target-version.outputs.BASE_VERSION_USED }}" "${{ steps.pr-info.outputs.RELEASE_TYPE }}")
          echo "$OUTPUT"
          echo "$OUTPUT" >> "$GITHUB_OUTPUT"

      - name: Commit version bump
        if: steps.check-bot-commit.outputs.SKIP == 'false' && steps.check-bump.outputs.SKIP == 'false'
        run: |
          if git diff --quiet package.json; then
            echo "No version change needed"
            exit 0
          fi
          git add package.json
          git commit -m "Bump version to v${{ steps.bump.outputs.VERSION_TO }}"
          git push

  release:
    name: "ðŸš€ Create release"
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: Checkout merged commit
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.merge_commit_sha }}
          fetch-depth: 0

      - uses: pnpm/action-setup@v4
      - uses: actions/setup-node@v4
        with:
          node-version-file: .node-version
          cache: "pnpm"

      - name: Install dependencies
        run: pnpm install

      - name: Read version from package.json
        id: version
        run: |
          set -euo pipefail
          OUTPUT=$(pnpm --filter=@dg/cli --silent version:read)
          echo "$OUTPUT"
          echo "$OUTPUT" >> "$GITHUB_OUTPUT"

      - name: Extract release notes
        id: notes
        run: |
          set -euo pipefail
          notes="$(pnpm --filter=@dg/cli --silent version:extract-notes "$GITHUB_EVENT_PATH")"
          delimiter="NOTES_$(uuidgen)"
          {
            echo "notes<<$delimiter"
            echo "$notes"
            echo "$delimiter"
          } >> "$GITHUB_OUTPUT"

      - name: Create GitHub release
        id: release
        uses: actions/github-script@v7
        env:
          VERSION: ${{ steps.version.outputs.VERSION }}
          NOTES: ${{ steps.notes.outputs.notes }}
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const tag = `v${process.env.VERSION}`;
            const body = process.env.NOTES || '';

            try {
              await github.rest.repos.getReleaseByTag({ owner, repo, tag });
              core.setFailed(`Release ${tag} already exists. Cannot create duplicate release.`);
              return;
            } catch (error) {
              if (error.status !== 404) throw error;
            }

            const { data: createdRelease } = await github.rest.repos.createRelease({
              owner,
              repo,
              tag_name: tag,
              name: tag,
              body,
              target_commitish: context.payload.pull_request.merge_commit_sha,
            });

            core.info(`Created release ${tag}`);
            core.setOutput('release_url', createdRelease.html_url);

      - name: Update PR version comment
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          VERSION: ${{ steps.version.outputs.VERSION }}
          RELEASE_URL: ${{ steps.release.outputs.release_url }}
        run: |
          set -euo pipefail
          pnpm --filter=@dg/cli --silent version:pr-comment "$GITHUB_EVENT_PATH" "$VERSION" released
