# Auto-bump version on PRs and create releases on merge
name: Release

on:
  pull_request:
    types: [opened, edited, synchronize, closed]
    branches: [main]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  TURBO_TOKEN: ${{ secrets.TURBO_TOKEN }}
  TURBO_TEAM: ${{ vars.TURBO_TEAM }}

jobs:
  bump:
    name: 'ðŸ“¦ Bump version'
    if: github.event.action != 'closed'
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: Checkout PR head with full history
        uses: actions/checkout@v4
        with:
          ref: ${{ github.head_ref }}
          fetch-depth: 0
          token: ${{ secrets.PAT_FOR_ACTIONS }}

      - uses: pnpm/action-setup@v4
      - uses: actions/setup-node@v4
        with:
          node-version-file: .node-version
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install

      - name: Configure git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Parse PR info
        id: pr-info
        run: |
          set -euo pipefail
          OUTPUT=$(./scripts/version-and-release pr-info "$GITHUB_EVENT_PATH")
          echo "$OUTPUT"
          echo "$OUTPUT" >> "$GITHUB_OUTPUT"

      - name: Read base version from main
        id: base-version
        run: |
          set -euo pipefail
          git fetch origin ${{ github.base_ref }}
          BASE_VERSION=$(git show origin/${{ github.base_ref }}:package.json | node -pe "JSON.parse(require('fs').readFileSync(0, 'utf8')).version")
          echo "VERSION=${BASE_VERSION}"
          echo "VERSION=${BASE_VERSION}" >> "$GITHUB_OUTPUT"

      - name: Read current version
        id: current-version
        run: |
          set -euo pipefail
          OUTPUT=$(./scripts/version-and-release read)
          echo "$OUTPUT"
          echo "$OUTPUT" >> "$GITHUB_OUTPUT"

      - name: Check if bump needed
        id: check-bump
        run: |
          BASE="${{ steps.base-version.outputs.VERSION }}"
          CURRENT="${{ steps.current-version.outputs.VERSION }}"
          if [ "$BASE" != "$CURRENT" ]; then
            echo "Version already bumped from ${BASE} to ${CURRENT}. Skipping."
            echo "SKIP=true" >> "$GITHUB_OUTPUT"
          else
            echo "Version needs bump from ${BASE}"
            echo "SKIP=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Bump version
        id: bump
        if: steps.check-bump.outputs.SKIP == 'false'
        run: |
          set -euo pipefail
          OUTPUT=$(./scripts/version-and-release bump "${{ steps.base-version.outputs.VERSION }}" "${{ steps.pr-info.outputs.RELEASE_TYPE }}")
          echo "$OUTPUT"
          echo "$OUTPUT" >> "$GITHUB_OUTPUT"

      - name: Commit version bump
        if: steps.check-bump.outputs.SKIP == 'false'
        run: |
          if git diff --quiet package.json; then
            echo "No version change needed"
            exit 0
          fi
          git add package.json
          git commit -m "Bump version to v${{ steps.bump.outputs.VERSION_TO }}"
          git push

  release:
    name: 'ðŸš€ Create release'
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout merged commit
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.merge_commit_sha }}
          fetch-depth: 0

      - name: Read version from package.json
        id: version
        run: |
          set -euo pipefail
          OUTPUT=$(./scripts/version-and-release read)
          echo "$OUTPUT"
          echo "$OUTPUT" >> "$GITHUB_OUTPUT"

      - name: Extract release notes
        id: notes
        run: |
          set -euo pipefail
          notes="$(./scripts/version-and-release extract-notes "$GITHUB_EVENT_PATH")"
          delimiter="NOTES_$(uuidgen)"
          {
            echo "notes<<$delimiter"
            echo "$notes"
            echo "$delimiter"
          } >> "$GITHUB_OUTPUT"

      - name: Create GitHub release
        uses: actions/github-script@v7
        env:
          VERSION: ${{ steps.version.outputs.VERSION }}
          NOTES: ${{ steps.notes.outputs.notes }}
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const tag = `v${process.env.VERSION}`;
            const body = process.env.NOTES || '';
            
            try {
              await github.rest.repos.getReleaseByTag({ owner, repo, tag });
              core.setFailed(`Release ${tag} already exists. Cannot create duplicate release.`);
              return;
            } catch (error) {
              if (error.status !== 404) throw error;
            }
            
            await github.rest.repos.createRelease({
              owner,
              repo,
              tag_name: tag,
              name: tag,
              body,
              target_commitish: context.payload.pull_request.merge_commit_sha,
            });
            
            core.info(`Created release ${tag}`);
