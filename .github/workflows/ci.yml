# CI checks the repo using formatting, types, tests, and PR screenshots
#
# Screenshots: Uses @vercel/before-and-after with agent-browser
# Screenshots config: .github/screenshot-config.json
# Vercel bypass: https://vercel.com/docs/security/deployment-protection/methods-to-bypass-deployment-protection/protection-bypass-automation

name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  deployment_status:

concurrency:
  group: ${{ github.workflow }}-${{ github.event_name }}-${{ github.ref }}
  cancel-in-progress: true

env:
  TURBO_TOKEN: ${{ secrets.TURBO_TOKEN }}
  TURBO_TEAM: ${{ vars.TURBO_TEAM }}
  DATABASE_URL_TEST: ${{ secrets.DATABASE_URL_TEST }}

jobs:
  # Standard CI checks - run on push/pull_request
  ci:
    if: github.event_name == 'push' || github.event_name == 'pull_request'
    timeout-minutes: 5
    runs-on: ubuntu-latest
    permissions:
      contents: read
    strategy:
      matrix:
        include:
          - command: "check:ci"
            name: "ðŸ§¹ Check"
          - command: "check:types"
            name: "ðŸ”Ž Check types"
          - command: "test"
            name: "ðŸ§ª Test"

    name: ${{ matrix.name }}

    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v4
      - uses: actions/setup-node@v4
        with:
          node-version-file: .node-version
          cache: "pnpm"
      - run: pnpm install
      - name: ${{ matrix.command }}
        run: NODE_OPTIONS=--max_old_space_size=8192 pnpm turbo ${{ matrix.command }}

  # PR Screenshots - run on successful Vercel preview deployments
  screenshots:
    name: ðŸ“¸ Screenshots
    if: |
      github.event_name == 'deployment_status' &&
      github.event.deployment_status.state == 'success' &&
      github.event.deployment.environment == 'Preview'
    runs-on: ubuntu-latest
    timeout-minutes: 10
    permissions:
      contents: read
      pull-requests: write
      deployments: read

    steps:
      - uses: actions/checkout@v4

      - uses: pnpm/action-setup@v4

      - uses: actions/setup-node@v4
        with:
          node-version-file: .node-version
          cache: "pnpm"

      - name: Install agent-browser and before-and-after
        run: |
          npm install -g agent-browser @vercel/before-and-after
          agent-browser install --with-deps

      - name: Get PR number
        id: pr
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_NUMBER=$(gh pr list --state open --json number,headRefOid \
            --jq ".[] | select(.headRefOid == \"${{ github.event.deployment.sha }}\") | .number")
          
          if [ -z "$PR_NUMBER" ]; then
            echo "No PR found for this deployment"
            echo "skip=true" >> $GITHUB_OUTPUT
          else
            echo "pr_number=$PR_NUMBER" >> $GITHUB_OUTPUT
            echo "skip=false" >> $GITHUB_OUTPUT
          fi

      - name: Check deployment protection
        if: steps.pr.outputs.skip != 'true'
        id: protection
        env:
          VERCEL_AUTOMATION_BYPASS_SECRET: ${{ secrets.VERCEL_AUTOMATION_BYPASS_SECRET }}
        run: |
          PREVIEW_URL="${{ github.event.deployment_status.target_url }}"
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" "$PREVIEW_URL" || echo "000")
          
          if [ "$HTTP_CODE" = "401" ] || [ "$HTTP_CODE" = "403" ]; then
            echo "âš ï¸ Preview deployment has password protection (HTTP $HTTP_CODE)"
            
            if [ -n "$VERCEL_AUTOMATION_BYPASS_SECRET" ]; then
              BYPASS_URL="${PREVIEW_URL}?x-vercel-protection-bypass=${VERCEL_AUTOMATION_BYPASS_SECRET}"
              BYPASS_CODE=$(curl -s -o /dev/null -w "%{http_code}" "$BYPASS_URL" || echo "000")
              
              if [ "$BYPASS_CODE" = "200" ] || [ "$BYPASS_CODE" = "304" ]; then
                echo "âœ… Bypass secret works (HTTP $BYPASS_CODE)"
                echo "protected=false" >> $GITHUB_OUTPUT
                echo "use_bypass=true" >> $GITHUB_OUTPUT
              else
                echo "âŒ Bypass secret failed (HTTP $BYPASS_CODE)"
                echo "protected=true" >> $GITHUB_OUTPUT
                echo "use_bypass=false" >> $GITHUB_OUTPUT
              fi
            else
              echo "âŒ No VERCEL_AUTOMATION_BYPASS_SECRET configured"
              echo "protected=true" >> $GITHUB_OUTPUT
              echo "use_bypass=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "âœ… Preview deployment accessible (HTTP $HTTP_CODE)"
            echo "protected=false" >> $GITHUB_OUTPUT
            echo "use_bypass=false" >> $GITHUB_OUTPUT
          fi

      - name: Capture before/after screenshots
        if: steps.pr.outputs.skip != 'true' && steps.protection.outputs.protected != 'true'
        id: capture
        env:
          VERCEL_AUTOMATION_BYPASS_SECRET: ${{ secrets.VERCEL_AUTOMATION_BYPASS_SECRET }}
          USE_BYPASS: ${{ steps.protection.outputs.use_bypass }}
        run: |
          CONFIG_FILE=".github/screenshot-config.json"
          PREVIEW_BASE_URL="${{ github.event.deployment_status.target_url }}"
          OUTPUT_DIR="./screenshots"
          
          mkdir -p "$OUTPUT_DIR"
          
          # Build bypass query string if needed
          BYPASS_PARAM=""
          if [ "$USE_BYPASS" = "true" ] && [ -n "$VERCEL_AUTOMATION_BYPASS_SECRET" ]; then
            BYPASS_PARAM="?x-vercel-protection-bypass=${VERCEL_AUTOMATION_BYPASS_SECRET}"
            echo "ðŸ”“ Using bypass secret for protected deployment"
          fi
          
          # Read config
          if [ -f "$CONFIG_FILE" ]; then
            PRODUCTION_URL=$(jq -r '.productionUrl' "$CONFIG_FILE")
            DEFAULT_VIEWPORT=$(jq -r '.defaultViewport // "1280x800"' "$CONFIG_FILE")
          else
            PRODUCTION_URL="https://dylangattey.com"
            DEFAULT_VIEWPORT="1280x800"
          fi
          
          echo "Production URL: $PRODUCTION_URL"
          echo "Preview URL: $PREVIEW_BASE_URL"
          echo "Default viewport: $DEFAULT_VIEWPORT"
          
          # Capture each configured page using before-and-after CLI
          if [ -f "$CONFIG_FILE" ] && [ "$(jq '.pages | length' "$CONFIG_FILE")" -gt 0 ]; then
            jq -c '.pages[]' "$CONFIG_FILE" | while read -r page; do
              PAGE_PATH=$(echo "$page" | jq -r '.path')
              PAGE_NAME=$(echo "$page" | jq -r '.name // .path')
              PAGE_VIEWPORT=$(echo "$page" | jq -r ".viewport // \"$DEFAULT_VIEWPORT\"")
              SAFE_NAME=$(echo "$PAGE_NAME" | tr ' /' '_-' | tr '[:upper:]' '[:lower:]')
              
              BEFORE_URL="${PRODUCTION_URL}${PAGE_PATH}"
              AFTER_URL="${PREVIEW_BASE_URL}${PAGE_PATH}${BYPASS_PARAM}"
              PAGE_OUTPUT_DIR="${OUTPUT_DIR}/${SAFE_NAME}"
              
              mkdir -p "$PAGE_OUTPUT_DIR"
              
              echo ""
              echo "ðŸ“¸ Capturing: $PAGE_NAME ($PAGE_PATH)"
              
              # Pre-warm pages to help with caching (before-and-after only waits 500ms)
              curl -s -o /dev/null "$BEFORE_URL" &
              curl -s -o /dev/null "$AFTER_URL" &
              wait
              sleep 2
              
              before-and-after "$BEFORE_URL" "$AFTER_URL" \
                --size "$PAGE_VIEWPORT" \
                --output "$PAGE_OUTPUT_DIR" \
                2>&1 || echo "  Warning: capture may have had issues for $PAGE_NAME"
            done
          else
            # Default: capture homepage only
            echo ""
            echo "ðŸ“¸ Capturing: Homepage (default)"
            PREVIEW_URL="${PREVIEW_BASE_URL}${BYPASS_PARAM}"
            
            # Pre-warm pages
            curl -s -o /dev/null "$PRODUCTION_URL" &
            curl -s -o /dev/null "$PREVIEW_URL" &
            wait
            sleep 2
            
            before-and-after "$PRODUCTION_URL" "$PREVIEW_URL" \
              --size "$DEFAULT_VIEWPORT" \
              --output "$OUTPUT_DIR" \
              2>&1 || echo "Screenshot capture completed with warnings"
          fi
          
          echo ""
          echo "Captured files:"
          find "$OUTPUT_DIR" -name "*.png" -type f 2>/dev/null || echo "No files captured"
          
          echo "output_dir=$OUTPUT_DIR" >> $GITHUB_OUTPUT

      - name: Upload screenshots
        if: steps.pr.outputs.skip != 'true' && steps.protection.outputs.protected != 'true'
        uses: actions/upload-artifact@v4
        with:
          name: pr-screenshots-${{ steps.pr.outputs.pr_number }}
          path: ${{ steps.capture.outputs.output_dir }}
          retention-days: 30

      - name: Upload images for PR comment
        if: steps.pr.outputs.skip != 'true' && steps.protection.outputs.protected != 'true'
        id: upload
        run: |
          OUTPUT_DIR="${{ steps.capture.outputs.output_dir }}"
          
          # Upload to litterbox.catbox.moe (temporary file hosting, 72h retention)
          # Works with CI unlike 0x0.st which blocks automated user agents
          upload_image() {
            local file="$1"
            curl -s -F "reqtype=fileupload" -F "time=72h" -F "fileToUpload=@$file" \
              "https://litterbox.catbox.moe/resources/internals/api.php"
          }
          
          MARKDOWN_ROWS=""
          UPLOADED_COUNT=0
          
          # before-and-after generates: {url}-{before|after}-{timestamp}.png
          # Before/after files share the same timestamp but have different URL prefixes
          # Match them by finding files with same timestamp in same directory
          
          for BEFORE_FILE in $(find "$OUTPUT_DIR" -name "*-before-*.png" -type f 2>/dev/null); do
            # Extract timestamp from filename (e.g., 2026-02-13T04-45-53)
            TIMESTAMP=$(echo "$BEFORE_FILE" | grep -oE '[0-9]{4}-[0-9]{2}-[0-9]{2}T[0-9]{2}-[0-9]{2}-[0-9]{2}')
            DIR=$(dirname "$BEFORE_FILE")
            
            # Find matching after file with same timestamp in same directory
            AFTER_FILE=$(find "$DIR" -name "*-after-${TIMESTAMP}.png" -type f 2>/dev/null | head -1)
            
            if [ -z "$AFTER_FILE" ] || [ ! -f "$AFTER_FILE" ]; then
              echo "No matching after file for: $BEFORE_FILE"
              continue
            fi
            
            # Extract page name from directory
            DIR_NAME=$(basename "$DIR")
            if [ "$DIR_NAME" = "screenshots" ] || [ "$DIR_NAME" = "." ]; then
              PAGE_NAME="Homepage"
            else
              PAGE_NAME=$(echo "$DIR_NAME" | tr '-_' ' ' | sed 's/\b\(.\)/\u\1/g')
            fi
            
            echo "Uploading: $PAGE_NAME"
            echo "  Before: $BEFORE_FILE"
            echo "  After: $AFTER_FILE"
            
            BEFORE_URL=$(upload_image "$BEFORE_FILE")
            AFTER_URL=$(upload_image "$AFTER_FILE")
            
            echo "  Before URL: $BEFORE_URL"
            echo "  After URL: $AFTER_URL"
            
            if [ -n "$BEFORE_URL" ] && [ -n "$AFTER_URL" ] && [[ "$BEFORE_URL" == http* ]]; then
              MARKDOWN_ROWS="${MARKDOWN_ROWS}| **${PAGE_NAME}** | ![Before](${BEFORE_URL}) | ![After](${AFTER_URL}) |
          "
              UPLOADED_COUNT=$((UPLOADED_COUNT + 1))
            else
              echo "  Upload failed or returned unexpected response"
            fi
          done
          
          if [ $UPLOADED_COUNT -gt 0 ]; then
            echo "uploaded=true" >> $GITHUB_OUTPUT
            echo "markdown_rows<<EOF" >> $GITHUB_OUTPUT
            echo "$MARKDOWN_ROWS" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
            echo "Uploaded $UPLOADED_COUNT page(s)"
          else
            echo "uploaded=false" >> $GITHUB_OUTPUT
            echo "No images uploaded"
          fi

      - name: Comment on PR
        if: steps.pr.outputs.skip != 'true' && steps.upload.outputs.uploaded == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = ${{ steps.pr.outputs.pr_number }};
            const previewUrl = '${{ github.event.deployment_status.target_url }}';
            const markdownRows = `${{ steps.upload.outputs.markdown_rows }}`;
            
            const body = `## ðŸ“¸ Visual comparison
            
            | Page | Before (production) | After (preview) |
            |:-----|:-------------------:|:---------------:|
            ${markdownRows}
            **Preview URL:** ${previewUrl}
            
            ---
            <sub>Generated by [before-and-after](https://jm.sv/before-and-after) â€¢ [View artifacts](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})</sub>`;
            
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
            });
            
            const botComment = comments.find(comment => 
              comment.user.type === 'Bot' && 
              comment.body.includes('ðŸ“¸ Visual comparison')
            );
            
            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: body,
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: body,
              });
            }

      - name: Comment about protection
        if: steps.pr.outputs.skip != 'true' && steps.protection.outputs.protected == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = ${{ steps.pr.outputs.pr_number }};
            const previewUrl = '${{ github.event.deployment_status.target_url }}';
            
            const body = `## ðŸ“¸ Visual comparison
            
            âš ï¸ **Screenshots skipped**: The preview deployment has password protection enabled and bypass failed.
            
            To enable automatic screenshots:
            1. Add \`VERCEL_AUTOMATION_BYPASS_SECRET\` to GitHub Actions secrets (must match the value in Vercel Project Settings > Deployment Protection > Protection Bypass for Automation)
            2. Or disable Vercel Deployment Protection for preview deployments
            
            **Preview URL:** ${previewUrl}
            
            ---
            <sub>Generated by [before-and-after](https://jm.sv/before-and-after)</sub>`;
            
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
            });
            
            const botComment = comments.find(comment => 
              comment.user.type === 'Bot' && 
              comment.body.includes('ðŸ“¸ Visual comparison')
            );
            
            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: body,
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: body,
              });
            }
